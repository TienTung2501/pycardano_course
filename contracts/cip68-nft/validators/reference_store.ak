use aiken/collection/list
use aiken/crypto.{Blake2b_224, Hash, VerificationKey}

use cardano/script_context as sc
use cardano/script_context.{ScriptContext}
use cardano/transaction.{Transaction, OutputReference}
use cardano/assets as assets

use cip68_nft/types.{StoreAction}
use cip68_nft/utils

// Äáº·t tÃªn validator: reference_store
validator reference_store(
  issuer: Hash<Blake2b_224, VerificationKey>,
) {
 spend(_datum: Option<Data>, rdmr: Option<StoreAction>, _own_ref: OutputReference, ctx: ScriptContext) -> Bool {
    
    // const PROJECT_VERSION = #"cip68_nfts_example_v1"  
    // let meta = MetaDatum::from_data(datum_data)
    let ScriptContext { transaction, info, .. } = ctx
    let Transaction { inputs, outputs, .. } = transaction

    // Own input reference tá»« ScriptInfo
    expect sc.Spending { output: own_ref, .. } = info
    // TÃ¬m input khá»›p own_ref
    expect Some(own_in) =
      list.find(inputs, fn (i) { i.output_reference == own_ref })

    // Non-ADA assets trong own input (mong Ä‘á»£i Ä‘Ãºng 1 ref asset)
    let ref_assets =
      own_in.output.value
        |> assets.without_lovelace()
        |> assets.flatten()

    expect 1 = list.length(ref_assets)
    expect Some((policy_id, tn_ref, _amt_in)) = list.head(ref_assets)

    // Issuer pháº£i kÃ½
    expect True = utils.is_signed_by(transaction, issuer)

   when rdmr is {
  // Update: tráº£ vá» cÃ¹ng script addr, giá»¯ asset + datum há»£p lá»‡
    Some(StoreAction.Update) -> {
      expect Some(out_ref) =
        list.find(outputs, fn (o) {
          o.address == own_in.output.address
            && utils.contains_asset(o.value, policy_id, tn_ref)
        })
      expect True = utils.check_output_utxo(out_ref)
      True
    }

    // Remove: cho rá»i khá»i script, nhÆ°ng output váº«n pháº£i giá»¯ shape datum + asset
    Some(StoreAction.Remove) -> {
      expect Some(out_any) =
        utils.find_output_by_asset(outputs, policy_id, tn_ref)
      expect True = utils.check_output_utxo(out_any)
      True
    }

      // ğŸ‘‡ Bá»• sung dÃ²ng nÃ y Ä‘á»ƒ trÃ¡nh lá»—i non-exhaustive
      _ -> False
    }

  }
}